<!DOCTYPE html>
<html>
<head>
  <title>Owner Call Interface</title>
</head>
<body>
  <h2>Owner Panel</h2>
  <label>Device ID:</label><input type="text" id="deviceId" value="1"><br>
  <label>Device User ID:</label><input type="text" id="deviceUserId" value="2"><br><br>
  <button onclick="connectSocket()">Connect</button>
  <button onclick="startCall()">Start Call</button>
  <button onclick="receiveCall()" id="receiveBtn" disabled>Receive Call</button>
  <button onclick="endCall()">End Call</button>
  <p id="status">Status: Not connected</p>
  <audio id="remoteAudio" autoplay></audio>
  <audio id="localAudio" autoplay muted></audio>

  <script>
    let socket, peer, localStream, incomingOffer = null;
    const jwt = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzUzNjQ3NTcxLCJpYXQiOjE3NTM2MDQzNzEsImp0aSI6IjRhNTAyNDNiNGFiZjRlMzk5OWJmMWFkYjNlNjc5NWMzIiwidXNlcl9pZCI6MSwidXNlciI6eyJpZCI6MSwidXNlcm5hbWUiOiJNZCBBYmR1bCBrYW1hbCIsImVtYWlsIjoibWlzaWplNzg3NkBlbmRpYml0LmNvbSIsInJvbGUiOiJvd25lciIsInJlc3RhdXJhbnRzX2lkIjoxLCJkZXZpY2VfaWQiOm51bGwsInN1YnNjcmlwdGlvbiI6eyJwYWNrYWdlX25hbWUiOm51bGwsInN0YXR1cyI6bnVsbCwiY3VycmVudF9wZXJpb2RfZW5kIjpudWxsfSwib3duZXJfaWQiOjF9fQ.xg6JCcDe1zB2oD6npROYTMjkIo3q3wxokZq5uVfTXAQ";
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    function updateStatus(text) {
      document.getElementById("status").innerText = `Status: ${text}`;
    }

    async function connectSocket() {
      const deviceId = document.getElementById("deviceId").value;
      socket = new WebSocket(`ws://10.10.13.26:9002/ws/call/${deviceId}/?token=${jwt}`);

      socket.onopen = async () => {
        updateStatus("Connected");
        await setupMedia();
      };

      socket.onerror = (e) => console.error("Socket error", e);
      socket.onclose = () => updateStatus("Disconnected");
      socket.onmessage = handleSocketMessage;
    }

    async function handleSocketMessage(event) {
      const data = JSON.parse(event.data);
      console.log("Received:", data);

      if (data.type === "answer") {
        await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
        updateStatus("Call connected");
      } else if (data.type === "candidate") {
        await peer.addIceCandidate(new RTCIceCandidate(data.candidate));
      } else if (data.action === "call_ended") {
        updateStatus("Call ended");
        closeCall();
      }
      else if(data.type === "offer"){
        incomingOffer = data.offer;
        document.getElementById("receiveBtn").disabled = false;
        updateStatus("Incoming call...");
      }
    }


    async function receiveCall() {
      if (!incomingOffer) return;
      document.getElementById("receiveBtn").disabled = true;
      updateStatus("Answering call...");

      await setupPeerConnection();
      await peer.setRemoteDescription(new RTCSessionDescription(incomingOffer));
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.send(JSON.stringify({ type: "answer", answer }));

      updateStatus("Call answered");
    }

    async function setupMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        console.log('Got MediaStream:', stream);
    });
        document.getElementById("localAudio").srcObject = localStream;
      } catch (err) {
        console.error("Media error:", err);
        updateStatus("Failed to access microphone");
      }
    }

    async function setupPeerConnection() {
      peer = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = ({ candidate }) => {
        if (candidate) {
          socket.send(JSON.stringify({ type: "candidate", candidate }));
        }
      };

      peer.ontrack = (event) => {
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };
    }

    async function startCall() {
      const receiverId = document.getElementById("deviceUserId").value;
      const deviceId = document.getElementById("deviceId").value;
      if (!socket || socket.readyState !== WebSocket.OPEN) return;

      await setupPeerConnection();
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);

      socket.send(JSON.stringify({
        action: "start_call",
        receiver_id: receiverId,
        device_id: deviceId,
        type: "offer",
        offer
      }));

      updateStatus("Calling device...");
    }

    function endCall() {
      const deviceId = document.getElementById("deviceId").value;
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ action: "end_call", device_id: deviceId }));
      }
      closeCall();
    }

    function closeCall() {
      if (peer) {
        peer.close();
        peer = null;
      }
      updateStatus("Idle");
      incomingOffer = null;
      document.getElementById("receiveBtn").disabled = true;
    }
  </script>
</body>
</html>